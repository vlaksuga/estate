<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/main.css">    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="/js/api.js"></script>    
    <script src="/js/main.js"></script>    
    <title>SEUM RMS</title>
</head>
<body>
    <div id="app" user="admin">
        <header loadsrc="../layout/header.html">
        </header>
        <main>
            <nav loadsrc="../layout/nav.html" currentmenu="realestate.html" auth="admin"></nav>
            <article>
                <div class="contentHeader">
                    <div class="contentHeaderStartContainer">
                        <div class="title">modify possession</div>
                    </div>
                    <div class="contentHeaderEndContainer"></div>
                </div>
                <div class="contentMain">
                    <div class="overflowContainer" style="max-height: calc(100vh - 150px); overflow-y: auto;">
                        <div class="cellView" style="width:75%">
                            <div class="cellCol">
                                <div class="cellRowTitle">공시 정보</div>
                                <div class="cellRow">                                
                                    <div class="cell view">
                                        <span class="cellTitle">지번</span>
                                        <span c-bind="estate.officialaddress:text"></span>
                                    </div>
                                    <div class="cell">
                                        <span class="cellTitle">동</span>
                                        <span c-bind="estate.townname:text"></span>
                                    </div>
                                    <div class="cell">
                                        <span class="cellTitle">지목</span>
                                        <span c-bind="estate.officialnomination:text"></span>
                                    </div>
                                    <div class="cell">
                                        <span class="cellTitle">건물명</span>
                                        <span c-bind="estate.officialbuildingname:text"></span>
                                    </div>
                                    <div class="cell">
                                        <span class="cellTitle">업종</span>
                                        <span c-bind="estate.officialbuildingsector:text"></span>
                                    </div>                            
                                </div>
    
                                <div class="cellRowTitle">소유자</div>
                                <div class="cellRow ownerlist">
                                    <div class="cellCol" style="width: 33%;">
                                        <div class="cellRow">
                                            <div class="cell">
                                                <span class="cellTitle">이름</span>
                                                <select name="ownerpkey" c-bind="ownerlist:listtemplete" c-tag="c-item" style="font-size: 12px;" id="ownerfilter" onchange="onSelectOnwer(this)" autoset="Y">
                                                    <option value="ALL">선택</option>
                                                    <option listtempitem c-item="ownername:option, ownerpkey:value"></option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="cellRow">
                                            <div class="cell">
                                                <span class="cellTitle">주민등록번호</span>
                                                <span class="owneridnumber"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="cellCol">
                                        <div class="cellRow">
                                            <div class="cell">
                                                <span class="cellTitle">주소</span>
                                                <span class="owneraddress"></span>
                                            </div>
                                        </div>
                                        <div class="cellRow">
                                            <div class="cell">
                                                <span class="cellTitle">TEL</span>
                                                <span class="ownertel"></span>
                                            </div>
                                            <div class="cell">
                                                <span class="cellTitle">PHONE</span>
                                                <span class="ownerphone"></span>
                                            </div>
                                        </div>
                                    </div>                                                                
                                </div>
    
    
                                <div class="cellRowTitle">소유권리</div>
                                <div class="cellRowSubtitle">토지</div>
                                <div class="cellRow">
                                    <div class="cellCol">
                                        <div class="cellRow">
                                            <div class="cell">
                                                <span class="cellTitle">소유자명</span>
                                                <span class="ownername"></span>
                                            </div>
                                        </div>
                                        <div class="cellRow">
                                            <div class="cell" for="possessionlandmeter">
                                                <span class="cellTitle">소유권이전일</span>
                                                <input type="date" name="landtransferdate" c-bind="landtransferdate:value:formatDateNum">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="cellCol">
                                        <div class="cellRow">
                                            <div class="cell">
                                                <span class="cellTitle">공시면적</span>
                                                <span id="landmeter" c-bind="estate.officiallandmeter:text:formatNumber"></span>
                                            </div>
                                        </div>
                                        <div class="cellRow">
                                            <div class="cell">
                                                <span class="cellTitle">공시가격</span>
                                                <span id="landprice" c-bind="estate.officiallandprice:text:formatWon"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="cellCol">
                                        <div class="cellRow">
                                            <label class="cell" for="possessionlandmeter">
                                                <span class="cellTitle">소유면적</span>
                                                <input type="text" c-bind="possessionlandmeter:value" name="possessionlandmeter" id="possessionlandmeter" placeholder="소유토지면적을 &#13217 단위의 숫자로 입력하세요. 예)8000" onfocus="this.value = ''" oninput="calcPercentMeter('landmeter', this, 'landmeterpercent')" value="0" onblur="this.value = formatNumber(parseFloat(this.value).toFixed(2))">
                                            </label>
                                        </div>
                                        <div class="cellRow">
                                            <label class="cell" for="landpurchaseprice">
                                                <span class="cellTitle">관리처분가</span>
                                                <input type="text" c-bind="landpurchaseprice:value:formatWon" name="landpurchaseprice" id="landpurchaseprice" placeholder="소유토지면적을 &#13217 단위의 숫자로 입력하세요. 예)8000" onfocus="this.value = ''" oninput="calcPercentPrice('landprice', this, 'landpricepercent')" value="0" onblur="this.value = formatWon(this.value)">
                                            </label>
                                        </div>
                                    </div>
                                    <div class="cellCol">
                                        <div class="cellRow">
                                            <div class="cell" for="possessionlandmeter">
                                                <span class="cellTitle">소유률</span>
                                                <span id="landmeterpercent" kind="land" c-bind="possessionlandmeter:text:initCalcMeter">소유면적을 입력하세요</span>
                                            </div>
                                        </div>
                                        <div class="cellRow">
                                            <div class="cell" for="possessionlandmeter">
                                                <span class="cellTitle">매매가율</span>
                                                <span id="landpricepercent" kind="land" c-bind="landpurchaseprice:text:initCalcPrice"></span>
                                            </div>
                                        </div>
                                    </div>               
                                </div>
                                
                                <div class="cellRowSubtitle">건물</div>
                                <div class="cellRow">
                                    <div class="cellCol">
                                        <div class="cellRow">
                                            <div class="cell">
                                                <span class="cellTitle ">소유자명</span>
                                                <span class="ownername"></span>
                                            </div>
                                        </div>
                                        <div class="cellRow">
                                            <div class="cell" for="buildingtransferdate">
                                                <span class="cellTitle">소유권이전일</span>
                                                <input type="date" name="buildingtransferdate" c-bind="buildingtransferdate:value:formatDateNum">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="cellCol">
                                        <div class="cellRow">
                                            <div class="cell">
                                                <span class="cellTitle">공시면적</span>
                                                <span id="buildingmeter" c-bind="estate.officialbuildingmeter:text:formatNumber"></span>
                                            </div>
                                        </div>
                                        <div class="cellRow">
                                            <div class="cell">
                                                <span class="cellTitle">공시가격</span>
                                                <span id="buildingprice" c-bind="estate.officialbuildingprice:text:formatWon"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="cellCol">
                                        <div class="cellRow">
                                            <label class="cell" for="possessionbuildingmeter">
                                                <span class="cellTitle">소유면적</span>
                                                <input type="text" name="possessionbuildingmeter" c-bind="possessionbuildingmeter:value" id="possessionlandmeter" placeholder="소유토지면적을 &#13217 단위의 숫자로 입력하세요. 예)8000" onfocus="this.value = ''" oninput="calcPercentMeter('buildingmeter', this, 'buildingmeterpercent')" value="0" onblur="this.value = formatNumber(parseFloat(this.value).toFixed(2))">
                                            </label>
                                        </div>
                                        <div class="cellRow">
                                            <label class="cell" for="buildingpurchaseprice">
                                                <span class="cellTitle">관리처분가</span>
                                                <input type="text" name="buildingpurchaseprice" c-bind="buildingpurchaseprice:value:formatWon" id="buildingpurchaseprice" placeholder="소유토지면적을 &#13217 단위의 숫자로 입력하세요. 예)8000" onfocus="this.value = ''" oninput="calcPercentPrice('buildingprice', this, 'buildingpricepercent')" value="0" onblur="this.value = formatWon(this.value)">
                                            </label>
                                        </div>
                                    </div>
                                    <div class="cellCol">
                                        <div class="cellRow">
                                            <div class="cell" for="possessionbuildingmeter">
                                                <span class="cellTitle">소유률</span>
                                                <span id="buildingmeterpercent" kind="building" c-bind="possessionbuildingmeter:text:initCalcMeter">소유면적을 입력하세요</span>
                                            </div>
                                        </div>
                                        <div class="cellRow">
                                            <div class="cell" for="possessionbuildingmeter">
                                                <span class="cellTitle">매매가율</span>
                                                <span id="buildingpricepercent" kind="building" c-bind="buildingpurchaseprice:text:initCalcPrice"></span>
                                            </div>
                                        </div>
                                    </div>               
                                </div>
                                <div class="rowFlexContainer" style="justify-content: flex-end;">
                                    <div class="buttonView" onclick="submitModifyPossession()">
                                        <span>확인</span>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                    </div>
                    
                </div>                
            </article>
            <aside></aside>
        </main>
    </div>
</body>
</html>

<script>
    function runSetup() {
        findItems(document);
        getPossession();
    }

    function getPossession() {
        API.getPossession({possessionpkey : getParam('possessionpkey')}).then(data => {            
            currentData = data.body.possession;
            API.listOwner().then(res => {
                currentData.ownerlist = res.body.ownerlist;
                currentData.ownerlist.sort((a, b) => { return a.ownername > b.ownername ? 1 : -1})
                bindView($('.cellView').get(0), currentData);
                const filter = $('#ownerfilter').get(0);
                if(filter.getAttribute('autoset') == "Y") {
                    const option = Array.from(filter.options).find(opt => { return opt.value == currentData.owner.ownerpkey });                    
                    filter.selectedIndex = option.index;
                    filter.onchange(filter);
                    filter.setAttribute('autoset', "N");
                }               
                console.log(currentData)
            });
        })
    }

    function onSelectOnwer(ele) {
        let ownerdata = {};
        currentData.ownerlist.forEach(owner => {
            if(owner.ownerpkey == ele.value) {
                ownerdata = owner;
            }
        });                
        bindOwner(ownerdata)      
    }

    function bindOwner(ownerdata) {
        for(const [k, v]  of Object.entries(ownerdata)) {
            let val = v;
            if(k == "ownertel" || k == "ownerphone") { val = formatTel(v); }
            $('.' + k).text(val);
        }        
    }

    function initCalcMeter(v, d, e) {
        const kind = e.getAttribute('kind');       
        const pVal = parseFloat(d.estate["official" + kind +"meter"]).toFixed(2);
        const cVal = parseFloat(v);
        const per =  ((cVal / pVal) * 100).toFixed(2);        
        return per + "%";
    }

    function initCalcPrice(v, d, e) {
        const kind = e.getAttribute('kind');       
        const pVal = parseFloat(d.estate["official" + kind +"price"]).toFixed(2);
        const cVal = parseFloat(v);
        const per =  ((cVal / pVal) * 100).toFixed(2);        
        return per + "%";
    }

   function calcPercentMeter(p, c, t) {
       const parent = document.getElementById(p);
       const child = c;
       const target = document.getElementById(t);       
       const pVal = parseFloat(parent.textContent.replace(/,/g, "")).toFixed(2);
       const cVal = parseFloat(child.value);
       const per =  ((cVal / pVal) * 100).toFixed(2);           
       if(isNaN(per)) { target.textContent = ""; return ;}       
       target.textContent = per + "%";   
   }

   function calcPercentPrice(p, c, t) {
       const parent = document.getElementById(p);
       const child = c;
       const target = document.getElementById(t);       
       const pVal = parseFloat(parent.textContent.replace(/,/g, "").replace("원", ""));
       const cVal = parseFloat(child.value);
       const per =  ((cVal / pVal) * 100).toFixed(2);       
       if(isNaN(per)) { target.textContent = ""; return ;}       
       target.textContent = per + "%";   
   }

    function submitModifyPossession() {
        var formData = getDataFrom('.cellView');
        console.log(formData);
        formData.possessionpkey = getParam('possessionpkey');        
        formData.landtransferdate = formData.landtransferdate.replace(/-/g, "");
        formData.possessionlandmeter = formData.possessionlandmeter.replace(/,/, "");
        formData.possessionbuildingmeter = formData.possessionbuildingmeter.replace(/,/, "");
        formData.buildingtransferdate = formData.buildingtransferdate.replace(/-/g, "");        
        formData.landpurchaseprice = formData.landpurchaseprice.replace(/,/g, "").replace("원", "");        
        formData.buildingpurchaseprice = formData.buildingpurchaseprice.replace(/,/g, "").replace("원", "");        
        if(!formData.landtransferdate || formData.landtransferdate == "") { formData.landtransferdate = "99991231"}
        if(!formData.buildingtransferdate || formData.buildingtransferdate == "") { formData.buildingtransferdate = "99991231"}


        console.log(formData);
        API.modifyPossession(formData).then(data => {
            if(data.head.status != "ok") { showToast('소유 권리를 수정하지 못했습니다.'); return ;}
            alert('소유 권리가 수정되었습니다.');
            location.href = "realestate.html";
        })    
    }
</script>